- hosts: all
  become: yes
  pre_tasks:
    - name: Ð¡heck host
      shell: |
        hostname
        printf "\n"
        ip a
      register: out
      changed_when: false
    - name: Show host
      debug:
        msg: "{{ out.stdout_lines }}"

    - name: Stoping and delete docker containers
      shell: |
        docker-compose -f /opt/nextcloud/docker-compose.yaml down
      args:
        executable: /bin/bash
      register: stop
      changed_when: false

    - name: Backup user data
      shell: |
        rsync -az /opt/nextcloud/app/ /opt/nextcloud/backups_nextcloud/app_data.$(date +%Y%m%d-%H.%M.%S)
        rsync -az /var/db/mysql/ /opt/nextcloud/backups_nextcloud/db_data.$(date +%Y%m%d-%H.%M.%S)
      args:
        executable: /bin/bash
      register: out
      changed_when: false
      become: yes
    - name: Print out
      debug:
        msg: "{{ out.stdout_lines  }}"

    - name: Remove docker images
      shell: |
        docker rmi nextcloud
        docker rmi mysql
      args:
        executable: /bin/bash
      register: out
      changed_when: false
    - name: Print out
      debug:
        msg: "{{ out.stdout_lines  }}"

    - name: Removing docker-compose file
      file:
        path: "{{ docker_compose_path }}"
        state: absent

  roles:
    - update

  post_tasks:
    - name: Check connection to Localhost
      wait_for:
        host: "localhost"
        port: "80"
        state: started
        timeout: 20
        register: out
    - name: print out
      debug:
        msg: "{{ out }}"

    - name: Pause for runing app
      pause:
        seconds: 20

    - block:
        - name: Check content to the site
          uri:
            url: "http://localhost"
            return_content: yes
          register: out
          failed_when: "'Nextcloud' not in out.content"
        - name: Print out
          debug:
            msg: "{{ out }}"
      rescue:
        - name: Rollback to previous version app
          include_role:
            name: rollback
            tasks_from: rollback
